jobs:
  - job: "buildMaster"
    timeoutInMinutes: 120
    steps:
      - script: make clean
        displayName: "clean nni source code"
      - script: python3 -m pip install --upgrade pip setuptools --user
        displayName: "Install python tools"
      - script: make easy-install
        displayName: "Install nni via source code"
      - script: |
          sudo apt-get install swig -y
          PATH=$HOME/.local/bin:$PATH nnictl package install --name=SMAC
          PATH=$HOME/.local/bin:$PATH nnictl package install --name=BOHB
        displayName: "Install dependencies for integration tests in remote mode"
  - job: "buildWorker"
    pool:
      name: NNI CI Windows GPU
    timeoutInMinutes: 120
    steps:
      - script: |
          conda activate l2w
          powershell .\uninstall.ps1
          powershell .\install.ps1
        displayName: "install"
  - job: "runTests"
    timeoutInMinutes: 120
    steps:
      - script: |
          set -e
          cd test
          python3 nni_test/nnitest/generate_ts_config.py --ts remote --remote_user $(remote_user) --remote_host $(remote_host) \
          --remote_port $(remote_port) --remote_pwd $(remote_pwd) --nni_manager_ip $(nni_manager_ip)
          cat config/training_service.yml
          PATH=$HOME/.local/bin:$PATH python3 nni_test/nnitest/run_tests.py --config config/integration_tests.yml --ts remote
        displayName: "integration test"
